<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Laika 파이프라인 테스트 패널</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --accent: #38bdf8;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --error: #f87171;
      --success: #34d399;
      --border: #1f2937;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 24px;
      font-family: "Segoe UI", "Noto Sans KR", sans-serif;
      background: radial-gradient(circle at 20% 20%, #1e293b, #0b1223 55%), var(--bg);
      color: var(--text);
    }
    h1 { margin: 0 0 8px; font-size: 28px; }
    p { margin: 4px 0 16px; color: var(--muted); }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .card {
      background: linear-gradient(145deg, #0b1223, #0f172a);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    .card h2 { margin: 0 0 8px; font-size: 18px; }
    label { display: block; margin: 8px 0 4px; color: var(--muted); font-size: 13px; }
    input {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #0b1223;
      color: var(--text);
      font-size: 14px;
    }
    button {
      margin-top: 12px;
      padding: 10px 14px;
      border: none;
      border-radius: 8px;
      background: var(--accent);
      color: #0b1223;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .note { font-size: 13px; color: var(--muted); margin-top: 6px; }
    .log {
      background: #0b1223;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      max-height: 240px;
      overflow: auto;
      font-family: "SFMono-Regular", Consolas, monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; }
    .pill.success { background: rgba(52,211,153,0.15); color: var(--success); }
    .pill.error { background: rgba(248,113,113,0.15); color: var(--error); }
    .pill.pending { background: rgba(56,189,248,0.15); color: var(--accent); }
    .chip { display: inline-block; padding: 4px 8px; border-radius: 999px; background: rgba(56,189,248,0.12); color: var(--text); margin: 2px; font-size: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 13px; }
    th, td { border: 1px solid var(--border); padding: 8px; text-align: left; vertical-align: top; }
    th { background: #111827; position: sticky; top: 0; z-index: 1; }
    .table-wrap { max-height: 360px; overflow: auto; border: 1px solid var(--border); border-radius: 10px; }
    .code-inline { font-family: "SFMono-Regular", Consolas, monospace; font-size: 12px; background: #0b1223; padding: 4px 6px; border-radius: 6px; display: inline-block; max-width: 360px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>Laika 파이프라인 테스트 패널</h1>
  <p>프로젝트 이름만 입력하고 DWG를 올리면, 버전 라벨(v1, v2...)을 자동으로 붙여서 변환/파싱을 실행합니다.</p>
  <div class="card" style="margin-bottom: 12px;">
    <h2>환경 설정</h2>
    <label>API Base URL</label>
    <input id="apiBase" value="http://localhost:8000" />
    <div class="note">docker-compose 기본 포트는 8000입니다.</div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>프로젝트</h2>
      <label>프로젝트 이름</label><input id="projectName" placeholder="예: 우리동네 주거동" />
      <button id="createProject">프로젝트 생성</button>
      <div class="note">project_id: <span id="projectIdDisplay" class="pill"></span></div>
    </div>

    <div class="card">
      <h2>DWG 업로드</h2>
      <input id="fileInput" type="file" accept=".dwg" multiple />
      <button id="uploadDwgs">선택한 DWG 업로드</button>
      <div class="note">업로드 시 자동으로 새 버전 라벨(v1, v2...)을 생성합니다.</div>
      <div class="note">이번 배치 버전 라벨: <span id="versionLabelDisplay" class="pill"></span></div>
    </div>
  </div>

    <div class="card" style="margin-top:16px;">
      <h2>업로드/작업 목록</h2>
      <div class="note">DWG를 업로드하면 자동 버전(v1,v2,...)이 생성되고, 변환 완료 후 DXF 다운로드 및 파싱을 실행할 수 있습니다.</div>
      <div id="fileList"></div>
    </div>

  <div class="card" style="margin-top:16px;">
    <h2>파싱 결과 미리보기</h2>
    <div id="parsedResult" class="note">파일을 선택하고 "파싱 결과" 버튼을 눌러 확인하세요.</div>
  </div>

  <div class="card" style="margin-top:16px;">
    <h2>로그</h2>
    <div id="log" class="log"></div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const apiBaseInput = $("apiBase");
    const logBox = $("log");
    const projectName = $("projectName");
    const projectIdDisplay = $("projectIdDisplay");
    const fileInput = $("fileInput");
    const versionLabelDisplay = $("versionLabelDisplay");
    const fileList = $("fileList");
    // 프로젝트 목록 패널 삽입 (앵커가 없으면 body 끝에 붙임)
    (function insertProjectList() {
      const projectListEl = document.createElement("div");
      projectListEl.className = "card";
      projectListEl.style.marginTop = "16px";
      projectListEl.innerHTML = `<h2>프로젝트 목록</h2><div id="projectList"></div>`;
      const anchor = document.querySelector(".card:nth-of-type(3)") || document.body.lastElementChild;
      if (anchor && anchor.parentNode) {
        anchor.parentNode.insertBefore(projectListEl, anchor);
      } else {
        document.body.appendChild(projectListEl);
      }
    })();

    const state = {
      projects: [],
      selectedProjectId: null,
      rows: [], // {projectId, fileId, filename, versionLabel, uploadPath, status, message, progress, pathDxf}
      versionCounters: {}, // projectId -> latest number
      currentParsed: null, // {fileId, metadata, counts, entities, total, meta_path}
    };

    function log(line, type = "info") {
      const stamp = new Date().toLocaleTimeString();
      const row = document.createElement("div");
      row.textContent = `[${stamp}] ${line}`;
      row.className = `log-line ${type}`;
      logBox.prepend(row);
    }

    async function api(path, opts = {}) {
      const base = apiBaseInput.value.replace(/\/$/, "");
      const res = await fetch(base + path, {
        ...opts,
      });
      const text = await res.text();
      let data = null;
      try { data = text ? JSON.parse(text) : null; } catch (_) {}
      if (!res.ok) {
        const msg = data?.detail || res.statusText || "API error";
        throw new Error(msg);
      }
      return data;
    }

    async function fetchProjects() {
      try {
        const projects = await api("/projects/");
        state.projects = projects;
        if (!state.selectedProjectId && projects.length > 0) {
          state.selectedProjectId = projects[0].id;
        }
        await fetchProjectDetails(state.selectedProjectId);
        renderProjects();
        renderFiles();
      } catch (e) {
        log(`프로젝트 조회 실패: ${e.message}`, "error");
      }
    }

    async function fetchProjectDetails(projectId) {
      if (!projectId) return;
      try {
        const versions = await api(`/projects/${projectId}/versions/`);
        const files = await api(`/projects/${projectId}/files/`);
        const versionNum = versions.length;
        state.versionCounters[projectId] = versionNum;
        versionLabelDisplay.textContent = `v${versionNum + 1}`;
        state.currentParsed = null;
        renderParsed();

        // 파일 rows 갱신: 해당 프로젝트 것만 교체
        state.rows = state.rows.filter((r) => r.projectId !== projectId);
        files.forEach((f) => {
          state.rows.push({
            projectId,
            fileId: f.id,
            filename: f.path_original ? f.path_original.split("/").pop() : f.id,
            versionLabel: f.version_label || "-",
            uploadPath: f.path_original,
            pathDxf: f.path_dxf,
            status: f.path_dxf ? "success" : "uploaded",
            message: "",
            progress: f.path_dxf ? 100 : 0,
          });
        });
      } catch (e) {
        log(`프로젝트 상세 조회 실패: ${e.message}`, "error");
      }
    }

    function renderProjects() {
      const list = document.getElementById("projectList");
      if (!list) return;
      list.innerHTML = "";
      if (state.projects.length === 0) {
        list.innerHTML = '<div class="note">생성된 프로젝트가 없습니다.</div>';
        return;
      }
      state.projects.forEach((p) => {
        const card = document.createElement("div");
        card.className = "card";
        card.style.cursor = "pointer";
        card.style.marginBottom = "8px";
        card.style.border = state.selectedProjectId === p.id ? "1px solid var(--accent)" : "1px solid var(--border)";
        card.innerHTML = `
          <div><strong>${p.name}</strong></div>
          <div class="note">${p.id}</div>
        `;
        card.onclick = async () => {
          state.selectedProjectId = p.id;
          projectIdDisplay.textContent = p.id;
          await fetchProjectDetails(p.id);
          renderProjects();
          renderFiles();
        };
        list.appendChild(card);
      });
    }

    function renderFiles() {
      if (!fileList) return;
      fileList.innerHTML = "";
      const rows = state.rows.filter((r) => r.projectId === state.selectedProjectId);
      if (rows.length === 0) {
        fileList.innerHTML = '<div class="note">업로드된 DWG가 없습니다. 파일을 업로드하세요.</div>';
        return;
      }
      rows.forEach((row, idx) => {
        const card = document.createElement("div");
        card.className = "card";
        card.style.marginBottom = "8px";

        const downloadLink = row.pathDxf
          ? `<a href="${apiBaseInput.value.replace(/\/$/, '')}/uploads/${row.fileId}/download" target="_blank" class="linkish">DXF 다운로드</a>`
          : '<span class="note">DXF 미생성</span>';

        const parseDisabled = row.status !== "success" || !row.pathDxf;

        card.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
            <div>
              <div><strong>${row.filename}</strong> <span class="pill">${row.versionLabel}</span></div>
              <div class="note">file_id: ${row.fileId || "-"}</div>
            </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button data-action="convert" data-idx="${idx}" ${row.status === "converting" ? "disabled" : ""}>변환</button>
            <button data-action="parse" data-idx="${idx}" ${parseDisabled ? "disabled" : ""}>파싱</button>
            <button data-action="preview" data-idx="${idx}" ${row.pathDxf ? "" : "disabled"}>파싱 결과</button>
            <button data-action="parse2" data-idx="${idx}" ${row.pathDxf ? "" : "disabled"}>2차 파싱</button>
          </div>
        </div>
          <div style="margin-top:8px;">
            <div class="note">상태: <span class="pill ${row.status}">${row.status}</span> ${row.message ? "(" + row.message + ")" : ""}</div>
            <div class="note">업로드 경로: ${row.uploadPath || "-"}</div>
            <div class="note">DXF: ${downloadLink}</div>
          </div>
          <div class="progress" style="margin-top:8px; height:8px; background:#1f2937; border-radius:6px; overflow:hidden;">
            <div style="height:100%; width:${row.progress || 0}%; background:${row.status === "failed" ? "var(--error)" : "var(--accent)"}; transition: width 0.3s;"></div>
          </div>
        `;
        fileList.appendChild(card);
      });

      fileList.querySelectorAll("button").forEach((btn) => {
        btn.onclick = () => {
          const idx = Number(btn.dataset.idx);
          const action = btn.dataset.action;
          const rows = state.rows.filter((r) => r.projectId === state.selectedProjectId);
          const row = rows[idx];
          const globalIdx = state.rows.findIndex((r) => r.fileId === row.fileId);
          if (action === "convert") startConvert(globalIdx);
          if (action === "parse") startParse(globalIdx);
          if (action === "preview") viewParsed(globalIdx);
          if (action === "parse2") startParse2(globalIdx);
        };
      });
    }

    $("createProject").onclick = async () => {
      try {
        const payload = { name: projectName.value || "demo project" };
        const data = await api("/projects/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        log(`프로젝트 생성 성공: ${data.id}`, "success");
        await fetchProjects();
      } catch (e) {
        log(`프로젝트 생성 실패: ${e.message}`, "error");
      }
    };

    $("uploadDwgs").onclick = async () => {
      try {
        if (!state.selectedProjectId) throw new Error("먼저 프로젝트를 선택하거나 생성하세요.");
        if (!fileInput.files || fileInput.files.length === 0) throw new Error("DWG 파일을 선택하세요.");

        const currentCount = state.versionCounters[state.selectedProjectId] || 0;
        const versionLabel = `v${currentCount + 1}`;
        versionLabelDisplay.textContent = versionLabel;

        // 버전 생성
        const version = await api(`/projects/${state.selectedProjectId}/versions/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ label: versionLabel }),
        });
        state.versionCounters[state.selectedProjectId] = currentCount + 1;
        log(`버전 생성: ${versionLabel} (${version.id})`, "success");

        // 파일 업로드
        for (const file of fileInput.files) {
          const form = new FormData();
          form.append("version_id", version.id);
          form.append("file", file);
          const data = await api("/uploads/upload", { method: "POST", body: form });
          state.rows.push({
            projectId: state.selectedProjectId,
            filename: file.name,
            versionLabel,
            fileId: data.file_id,
            uploadPath: data.upload_path,
            status: "uploaded",
            message: "",
            progress: 0,
          });
          log(`업로드 완료: ${file.name} (file_id=${data.file_id})`, "success");
        }
        fileInput.value = "";
        renderFiles();
      } catch (e) {
        log(`업로드 실패: ${e.message}`, "error");
      }
    };

    async function startConvert(idx) {
      const row = state.rows[idx];
      if (!row?.fileId) return;
      row.status = "converting";
      row.progress = 20;
      renderFiles();
      try {
        await api(`/uploads/${row.fileId}/convert`, { method: "POST" });
        log(`변환 요청: ${row.filename}`, "info");
        pollStatus(idx, { target: "convert" });
      } catch (e) {
        row.status = "failed";
        row.message = e.message;
        renderFiles();
        log(`변환 실패: ${row.filename} (${e.message})`, "error");
      }
    }

    async function startParse2(idx) {
      const row = state.rows[idx];
      if (!row?.fileId) return;
      try {
        await api(`/uploads/${row.fileId}/parse2`, { method: "POST" });
        log(`2차 파싱 요청: ${row.filename}`, "info");
      } catch (e) {
        log(`2차 파싱 실패: ${e.message}`, "error");
      }
    }

    async function startParse(idx) {
      const row = state.rows[idx];
      if (!row?.fileId) return;
      if (row.status !== "success" || !row.pathDxf) {
        log("DXF 변환이 완료된 후 파싱할 수 있습니다.", "error");
        return;
      }
      row.status = "parsing";
      row.progress = 20;
      renderFiles();
      try {
        await api(`/uploads/${row.fileId}/parse`, { method: "POST" });
        log(`파싱 요청: ${row.filename}`, "info");
        pollStatus(idx, { target: "parse" });
      } catch (e) {
        row.status = "failed";
        row.message = e.message;
        renderFiles();
        log(`파싱 실패: ${row.filename} (${e.message})`, "error");
      }
    }

    async function pollStatus(idx, options = {}) {
      const row = state.rows[idx];
      if (!row?.fileId) return;
      try {
        const data = await api(`/uploads/${row.fileId}/status`);
        row.status = data.status;
        row.message = data.message || "";
        row.pathDxf = data.path_dxf || row.pathDxf;
        if (data.status === "pending") {
          row.progress = Math.min((row.progress || 10) + 10, 90);
          renderFiles();
          setTimeout(() => pollStatus(idx, options), 2000);
        } else if (data.status === "success") {
          row.progress = 100;
          renderFiles();
          log(`${options.target === "parse" ? "파싱" : "변환"} 완료: ${row.filename}`, "success");
        } else {
          row.progress = 100;
          renderFiles();
          log(`${options.target === "parse" ? "파싱" : "변환"} 실패: ${row.filename} (${row.message})`, "error");
        }
      } catch (e) {
        log(`상태 조회 실패: ${e.message}`, "error");
      }
    }

    async function viewParsed(idx) {
      const row = state.rows[idx];
      if (!row?.fileId) return;
      try {
        const data = await api(`/uploads/${row.fileId}/parsed`);
        state.currentParsed = { ...data, filename: row.filename };
        renderParsed();
        log(`파싱 결과 조회: ${row.filename}`, "info");
      } catch (e) {
        log(`파싱 결과 조회 실패: ${e.message}`, "error");
      }
    }

    function renderParsed() {
      const box = $("parsedResult");
      if (!box) return;
      const data = state.currentParsed;
      if (!data) {
        box.innerHTML = '<div class="note">파일을 선택하고 "파싱 결과"를 눌러주세요.</div>';
        return;
      }

      const documentMeta = (data.metadata || []).find((m) => m.section === "document");
      const headerMeta = (data.metadata || []).find((m) => m.section === "header");
      const tablesMeta = (data.metadata || []).find((m) => m.section === "tables");
      const layoutsMeta = (data.metadata || []).find((m) => m.section === "layouts");

      const renderKeyValueTable = (title, obj) => {
        if (!obj) return `<div class="note">${title}: 데이터 없음</div>`;
        const rows = Object.entries(obj)
          .filter(([k]) => k !== "section")
          .map(([k, v]) => `<tr><th>${k}</th><td><div class="code-inline">${JSON.stringify(v, null, 2)}</div></td></tr>`)
          .join("");
        return `
          <h3 style="margin-top:12px;">${title}</h3>
          <div class="table-wrap">
            <table><tbody>${rows}</tbody></table>
          </div>
        `;
      };

      const renderListTable = (title, items = [], columns = []) => {
        if (!items || items.length === 0) return `<div class="note">${title}: 데이터 없음</div>`;
        const header = columns.map((c) => `<th>${c}</th>`).join("");
        const rows = items
          .map((item) => `<tr>${columns.map((c) => `<td>${JSON.stringify(item?.[c] ?? "-", null, 2)}</td>`).join("")}</tr>`)
          .join("");
        return `
          <h3 style="margin-top:12px;">${title}</h3>
          <div class="table-wrap">
            <table>
              <thead><tr>${header}</tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        `;
      };

      const counts = data.counts || {};
      const countChips = Object.keys(counts).length
        ? Object.entries(counts)
            .map(([k, v]) => `<span class="chip">${k}: ${v}</span>`)
            .join("")
        : '<div class="note">엔티티가 없습니다.</div>';

      const entities = (data.entities || [])
        .map(
          (e) => `
            <tr>
              <td>${e.id}</td>
              <td>${e.type}</td>
              <td>${e.layer || "-"}</td>
              <td>${e.length ?? "-"}</td>
              <td>${e.area ?? "-"}</td>
              <td><div class="code-inline">${JSON.stringify(e.properties || {}, null, 2)}</div></td>
            </tr>
          `
        )
        .join("");

      box.innerHTML = `
        <div class="note">파일: ${data.filename || data.file_id || "-"} / 총 엔티티: ${data.total ?? 0} / 메타: ${data.meta_path || "-"}</div>
        <div style="margin:8px 0;">${countChips}</div>
        ${renderKeyValueTable("파일/문서", documentMeta)}
        ${renderKeyValueTable("HEADER 섹션", headerMeta)}
        ${
          tablesMeta
            ? [
                renderListTable("TABLES - LAYERS", tablesMeta.layers, ["name", "color_index", "true_color", "linetype", "is_on", "is_locked", "is_plottable"]),
                renderListTable("TABLES - LINETYPES", tablesMeta.linetypes, ["name", "length", "pattern"]),
                renderListTable("TABLES - TEXT_STYLES", tablesMeta.text_styles, ["name", "font", "height", "width_factor", "oblique"]),
                renderListTable("TABLES - DIMENSION_STYLES", tablesMeta.dim_styles, ["name", "arrow_size", "text_height", "unit_format", "tolerance"]),
                renderListTable("TABLES - BLOCK_RECORDS", tablesMeta.block_records, ["name", "entity_count", "insert_count", "description", "base_point"]),
              ].join("")
            : '<div class="note">TABLES 섹션: 데이터 없음</div>'
        }
        ${
          layoutsMeta
            ? renderListTable(
                "PaperSpace / Layouts",
                layoutsMeta.layouts,
                ["name", "scale", "tab_order", "unit_factor", "plot_layout_flags", "viewports"]
              )
            : '<div class="note">PaperSpace / Layouts: 데이터 없음</div>'
        }
        <h3 style="margin-top:12px;">엔티티 미리보기 (전체)</h3>
        <div class="table-wrap">
          ${
            entities
              ? `<table>
                  <thead>
                    <tr><th>ID</th><th>Type</th><th>Layer</th><th>Length</th><th>Area</th><th>Properties</th></tr>
                  </thead>
                  <tbody>${entities}</tbody>
                </table>`
              : '<div class="note" style="padding:8px;">표시할 엔티티가 없습니다.</div>'
          }
        </div>
      `;
    }

    // 초기 로드
    fetchProjects();
  </script>
</body>
</html>
