<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LAIKA</title>
  <style>
    :root {
      --bg: #0c1018;
      --surface: #0f1724;
      --surface-2: #111b2c;
      --border: #1f2c3e;
      --accent: #6df3c3;
      --accent-2: #61a8ff;
      --text: #e6edf7;
      --muted: #9fb3ce;
      --error: #ff6b6b;
      --success: #6df3c3;
      --warn: #f2c84b;
      --shadow: 0 20px 60px rgba(0,0,0,0.35);
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Pretendard", "Noto Sans KR", "Segoe UI", sans-serif;
      background: radial-gradient(120% 120% at 20% 0%, rgba(97,168,255,0.08), transparent 40%), radial-gradient(120% 120% at 80% 20%, rgba(109,243,195,0.08), transparent 45%), #060910;
      color: var(--text);
      min-height: 100vh;
      padding: 0 20px 48px;
    }
    a { color: inherit; text-decoration: none; }
    header {
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(12px);
      background: rgba(6, 9, 16, 0.9);
      border-bottom: 1px solid var(--border);
    }
    .nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 6px;
      max-width: 1200px;
      margin: 0 auto;
      gap: 16px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 800;
      letter-spacing: 0.6px;
      cursor: pointer;
    }
    .brand-mark {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      display: grid;
      place-items: center;
      color: #0a0f17;
      font-weight: 900;
      font-size: 16px;
      box-shadow: 0 10px 30px rgba(109,243,195,0.25);
    }
    .tabs {
      display: flex;
      gap: 12px;
      flex: 1;
      justify-content: center;
      flex-wrap: wrap;
    }
    .tab {
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(17, 27, 44, 0.7);
      color: var(--muted);
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 600;
    }
    .tab.active {
      color: #0a0f17;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: 0 10px 25px rgba(109,243,195,0.25);
      border-color: transparent;
    }
    .nav-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .badge {
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(97,168,255,0.12);
      border: 1px solid var(--border);
      font-size: 12px;
      color: var(--text);
    }
    .btn {
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn.primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #0a0f17;
      border: none;
      box-shadow: 0 14px 40px rgba(97,168,255,0.25);
    }
    .btn.ghost { background: transparent; }
    .btn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }
    main {
      max-width: 1200px;
      margin: 24px auto 0;
    }
    section {
      display: none;
      animation: fadeIn 0.35s ease;
    }
    section.active { display: block; }
    .hero {
      background: linear-gradient(145deg, rgba(17,27,44,0.75), rgba(7,11,19,0.95));
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 32px;
      box-shadow: var(--shadow);
    }
    .hero h1 { margin: 0 0 12px; font-size: 28px; }
    .hero p { margin: 4px 0 14px; color: var(--muted); }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(97,168,255,0.12);
      color: var(--text);
      font-size: 12px;
      border: 1px solid var(--border);
    }
    .layout {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
    }
    .card h3 { margin: 0 0 10px; font-size: 18px; }
    .muted { color: var(--muted); font-size: 14px; margin: 6px 0 12px; }
    .field {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }
    .field label { color: var(--muted); font-size: 13px; }
    .input {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface-2);
      color: var(--text);
      font-size: 14px;
    }
    .dropzone {
      border: 1.5px dashed var(--border);
      border-radius: 14px;
      padding: 26px;
      text-align: center;
      background: rgba(17,27,44,0.5);
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .dropzone.dragover {
      border-color: var(--accent);
      background: rgba(109,243,195,0.08);
      box-shadow: 0 10px 30px rgba(109,243,195,0.15);
    }
    .file-list { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
    .file-row {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      display: grid;
      grid-template-columns: 1.3fr 1fr 0.9fr;
      gap: 10px;
      align-items: center;
    }
    .file-main { display: flex; flex-direction: column; gap: 6px; }
    .file-name { font-weight: 700; }
    .progress {
      width: 100%;
      height: 10px;
      border-radius: 12px;
      background: rgba(31,44,62,0.8);
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      transition: width 0.25s ease;
    }
    .status-line {
      font-size: 13px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .status-pill {
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
      border: 1px solid var(--border);
      color: var(--muted);
    }
    .status-pill.ready { color: var(--text); }
    .status-pill.uploading { color: var(--accent-2); border-color: rgba(97,168,255,0.4); }
    .status-pill.processing { color: var(--accent); border-color: rgba(109,243,195,0.4); }
    .status-pill.done { color: var(--success); border-color: rgba(109,243,195,0.5); }
    .status-pill.failed { color: var(--error); border-color: rgba(255,107,107,0.5); }
    .actions-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .accordion {
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: var(--surface-2);
      margin-top: 12px;
    }
    .acc-header {
      padding: 12px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      background: rgba(255,255,255,0.02);
    }
    .acc-body {
      padding: 14px;
      border-top: 1px solid var(--border);
      display: none;
    }
    .acc-body.open { display: block; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 13px;
    }
    th, td {
      border: 1px solid var(--border);
      padding: 8px;
      text-align: left;
      color: var(--text);
    }
    th { background: rgba(255,255,255,0.03); }
    .table-wrap {
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: auto;
      max-height: 260px;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      font-size: 12px;
    }
    .pill-success { color: var(--success); }
    .pill-warn { color: var(--warn); }
    .pill-error { color: var(--error); }
    .capsule {
      background: rgba(97,168,255,0.1);
      border: 1px solid var(--border);
      padding: 10px 12px;
      border-radius: 12px;
      margin-bottom: 10px;
      display: inline-flex;
      gap: 8px;
      align-items: center;
      font-size: 13px;
      color: var(--text);
    }
    .pill-lock {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(255,255,255,0.03);
      border: 1px dashed var(--border);
      color: var(--muted);
      font-size: 13px;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @media (max-width: 960px) {
      .layout { grid-template-columns: 1fr; }
      .file-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand" id="btnHome">
        <div class="brand-mark">L</div>
        <div>
          <div style="font-size:14px; color: var(--muted);">AI 도면 플랫폼</div>
          <div style="font-size:16px;">LAIKA</div>
        </div>
      </div>
      <div class="tabs">
        <div class="tab" data-tab="convert">DXF 변환</div>
        <div class="tab" data-tab="analyze">AI 도면 분석</div>
        <div class="tab" data-tab="generate">AI 도면 생성</div>
      </div>
      <div class="nav-actions">
        <div class="badge" id="userBadge">게스트 · 비로그인</div>
        <button class="btn ghost" id="btnSignup">회원가입</button>
        <button class="btn ghost" id="btnLogin">로그인</button>
      </div>
    </div>
  </header>

  <main>
    <section id="home" class="active">
      <div class="hero">
        <div class="pill">LAIKA · Intelligent Drawing Automation</div>
        <h1>DWG/DXF 파이프라인을 한 곳에서.<br />업로드·분석·생성을 모두 자동화하세요.</h1>
        <p>DWG → DXF 변환, AI 기반 도면 분석, 도면 생성까지 하나의 워크플로우로 제공합니다. 업로드만 하면 버전 관리와 파싱, 분석 결과 시각화가 이어집니다.</p>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
          <button class="btn primary" data-tab-jump="convert">DXF 변환 시작</button>
          <button class="btn" data-tab-jump="analyze">AI 도면 분석 보기</button>
          <div class="pill-lock">로그인 시 AI 도면 분석 가능 · 구독 시 AI 도면 생성 활성화</div>
        </div>
      </div>
      <div class="layout" style="margin-top:18px;">
        <div class="card">
          <h3>LAIKA가 하는 일</h3>
          <div class="muted">업로드 → 변환 → 파싱 → 분석 → 생성까지 이어지는 여정을 미리 확인하세요.</div>
          <div style="display:flex; flex-direction:column; gap:12px;">
            <div class="capsule"><span class="pill-success">1</span>DWG를 DXF로 변환 (odaconverter)</div>
            <div class="capsule"><span class="pill-success">2</span>기본 파싱 (ezdxf) · 엔티티/레이어/블록 DB 적재</div>
            <div class="capsule"><span class="pill-warn">3</span>블록/레이어 역할 지정 · 축선/구조체/도곽 설정</div>
            <div class="capsule"><span class="pill-warn">4</span>AI 분석 실행 · 결과 표/다이아그램 다운로드</div>
            <div class="capsule"><span class="pill-error">5</span>구독 시 AI 도면 생성(Coming soon)</div>
          </div>
        </div>
        <div class="card">
          <h3>접근 권한</h3>
          <div class="muted">페이지별 이용 조건입니다.</div>
          <div style="display:flex; flex-direction:column; gap:10px;">
            <div class="tag"><span class="pill-success">공개</span> DXF 변환 · 누구나 사용</div>
            <div class="tag"><span class="pill-warn">로그인 필요</span> AI 도면 분석 · 회원만</div>
            <div class="tag"><span class="pill-error">구독 필요</span> AI 도면 생성 · 결제 구독자 전용</div>
          </div>
        </div>
      </div>
    </section>

    <section id="login">
      <div class="hero">
        <div class="pill">로그인</div>
        <h1>다시 만나서 반가워요</h1>
        <p>테스트 계정: admin/admin(관리자, 구독), aaa/aaa(회원), bbb/bbb(회원+구독)</p>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <span class="capsule">admin / admin · 관리자 · 구독</span>
          <span class="capsule">aaa / aaa · 일반 · 미구독</span>
          <span class="capsule">bbb / bbb · 일반 · 구독</span>
        </div>
      </div>
      <div class="layout">
        <div class="card" style="grid-column: span 2;">
          <h3>로그인 폼</h3>
          <div class="field">
            <label>아이디</label>
            <input class="input" id="loginId" placeholder="아이디" />
          </div>
          <div class="field">
            <label>비밀번호</label>
            <input class="input" id="loginPwd" placeholder="비밀번호" type="password" />
          </div>
          <div class="actions-row">
            <button class="btn primary" id="btnDoLogin">로그인</button>
            <button class="btn" data-tab-jump="signup">회원가입으로 이동</button>
          </div>
        </div>
      </div>
    </section>

    <section id="signup">
      <div class="hero">
        <div class="pill">회원가입</div>
        <h1>새 계정을 만들어보세요</h1>
        <p>회원가입 후 AI 도면 분석을 이용할 수 있습니다. 구독은 로그인 후 "구독하기" 버튼으로 전환하세요.</p>
      </div>
      <div class="layout">
        <div class="card" style="grid-column: span 2;">
          <h3>회원가입 폼</h3>
          <div class="field">
            <label>아이디</label>
            <input class="input" id="signupId" placeholder="아이디" />
          </div>
          <div class="field">
            <label>비밀번호</label>
            <input class="input" id="signupPwd" placeholder="비밀번호" type="password" />
          </div>
          <div class="field">
            <label>비밀번호 확인</label>
            <input class="input" id="signupPwd2" placeholder="비밀번호 확인" type="password" />
          </div>
          <div class="actions-row">
            <button class="btn primary" id="btnDoSignup">가입하기</button>
            <button class="btn" data-tab-jump="login">로그인으로 이동</button>
          </div>
        </div>
      </div>
    </section>

    <section id="convert">
      <div class="hero">
        <div class="pill">STEP 1 · DXF 변환기</div>
        <h1>DWG를 DXF로 변환하세요</h1>
        <p>최대 100MB 파일을 업로드하고 변환 현황을 실시간으로 확인하세요.</p>
        <div class="muted">상태 로그: 준비 → 업로드 중 → DXF 변환 중 → 완료 · 실패</div>
      </div>
      <div class="layout">
        <div class="card" style="grid-column: span 2;">
          <h3>파일 업로드 · 작업 제어</h3>
          <div class="muted">DWG를 추가하고 바로 변환/다운로드를 실행하세요.</div>
          <div class="dropzone" id="dropConvert">
            <div style="font-size:15px; font-weight:700;">파일 선택 또는 여기로 드롭 (최대 100MB)</div>
            <div class="muted" style="margin-top:6px;">DWG 지원 · 변환 결과는 동일한 파일명으로 DXF 다운로드</div>
            <input type="file" id="inputConvert" accept=".dwg" multiple style="display:none;" />
          </div>
          <div class="actions-row" style="margin-top:12px;">
            <button class="btn primary" id="btnConvertStart">변환하기</button>
            <button class="btn" id="btnConvertDownload">다운로드</button>
          </div>
          <div class="muted" style="margin-top:8px;">선택된 파일이 없으면 전체 변환을 실행합니다.</div>
          <div class="file-list" id="convertList"></div>
        </div>
      </div>
    </section>

    <section id="analyze">
      <div class="hero">
        <div class="pill">STEP 2 · AI 도면 분석기</div>
        <h1>AI로 DXF 도면을 분석하세요</h1>
        <p>업로드 후 기본 파싱(ezdxf) → 블록/레이어 지정 → 분석 결과 확인까지 한 흐름으로 진행됩니다.</p>
        <div class="muted">상태 로그: 준비 → 업로드 중 → 파싱 중 → 완료 · 실패</div>
        <div id="analyzeLock" class="pill-lock" style="margin-top:8px;">로그인 시 이용 가능합니다.</div>
      </div>
      <div class="layout">
        <div class="card" style="grid-column: span 2;">
          <h3>파일 업로드 · 분석 단계</h3>
          <div class="muted">DXF를 추가하고 기본 파싱/다음 단계로 바로 진행하세요.</div>
          <div class="dropzone" id="dropAnalyze">
            <div style="font-size:15px; font-weight:700;">파일 선택 또는 여기로 드롭 (최대 100MB)</div>
            <div class="muted" style="margin-top:6px;">DXF 지원 · 업로드 후 기본 파싱</div>
            <input type="file" id="inputAnalyze" accept=".dxf" multiple style="display:none;" />
          </div>
          <div class="actions-row" style="margin-top:12px;">
            <button class="btn primary" id="btnParse">파싱하기</button>
            <button class="btn" id="btnNext">다음으로</button>
          </div>
          <div class="muted" style="margin-top:8px;">세부 설정 완료 후 분석 결과 페이지로 이동합니다.</div>
          <div class="file-list" id="analyzeList"></div>
        </div>
      </div>
      <div class="layout" style="margin-top:16px;">
        <div class="card">
          <h3>세부 설정</h3>
          <div class="muted">블록/레이어 역할을 지정하세요.</div>
          <div class="field">
            <label>도곽 블록</label>
            <input class="input" id="blockTitle" placeholder="예: TITLE_BLOCK_A" />
          </div>
          <div class="field">
            <label>레이어 매핑</label>
            <div style="display:grid; gap:8px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
              <input class="input" id="layerAxis" placeholder="축선 레이어" />
              <input class="input" id="layerConcrete" placeholder="콘크리트 레이어" />
              <input class="input" id="layerSteel" placeholder="철골 구조 레이어" />
              <input class="input" id="layerWall" placeholder="비구조 벽체 레이어" />
            </div>
          </div>
          <div class="actions-row">
            <button class="btn primary" id="btnAnalyze">분석하기</button>
          </div>
        </div>
        <div class="card">
          <h3>분석 결과</h3>
          <div class="muted">좌측 리스트에서 파일을 선택하면 우측에 결과가 표시됩니다.</div>
          <div class="layout" style="grid-template-columns: 1fr 1.6fr; gap:12px; margin-top:8px;">
            <div class="card" style="padding:12px; background: var(--surface-2);">
              <h4 style="margin:0 0 8px;">파일 리스트</h4>
              <div id="resultList" class="file-list"></div>
            </div>
            <div class="card" style="padding:12px; background: var(--surface-2);">
              <div id="resultView" class="muted">파일을 선택하세요.</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="generate">
      <div class="hero">
        <div class="pill">STEP 3 · AI 도면 생성</div>
        <h1>AI 도면 생성 (준비중)</h1>
        <p>구독 결제 후 사용할 수 있는 기능입니다. 요구 사항을 알려주시면 반영하겠습니다.</p>
        <div id="generateLock" class="pill-lock" style="margin-top:8px;">구독 결제 시 활성화됩니다.</div>
        <div class="actions-row" style="margin-top:12px;">
          <button class="btn primary" id="btnSubscribe">구독하기</button>
          <button class="btn" id="btnNotify">알림받기</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    const $ = (id) => document.getElementById(id);
    const state = {
      activeTab: "home",
      loggedIn: false,
      subscribed: false,
      user: null,
      users: [
        { id: "admin", pwd: "admin", role: "admin", subscribed: true },
        { id: "aaa", pwd: "aaa", role: "user", subscribed: false },
        { id: "bbb", pwd: "bbb", role: "user", subscribed: true },
      ],
      convertFiles: [],
      analyzeFiles: [],
      selectedResult: null,
    };

    function setTab(tab) {
      if (tab === "analyze" && !state.loggedIn) {
        alert("AI 도면 분석은 로그인 후 이용 가능합니다.");
        tab = "login";
      }
      if (tab === "generate" && (!state.loggedIn || !state.subscribed)) {
        if (!state.loggedIn) {
          alert("AI 도면 생성은 로그인 후 이용 가능합니다.");
          tab = "login";
        } else {
          alert("AI 도면 생성은 구독 후 이용 가능합니다.");
          tab = "generate";
        }
      }
      state.activeTab = tab;
      document.querySelectorAll(".tab").forEach((el) => el.classList.toggle("active", el.dataset.tab === tab));
      document.querySelectorAll("section").forEach((sec) => sec.classList.toggle("active", sec.id === tab));
      if ($("analyzeLock")) {
        $("analyzeLock").style.display = state.loggedIn ? "none" : "inline-flex";
      }
      if ($("generateLock")) {
        $("generateLock").style.display = state.subscribed ? "none" : "inline-flex";
      }
    }

    document.querySelectorAll(".tab").forEach((tab) => {
      tab.addEventListener("click", () => setTab(tab.dataset.tab));
    });
    document.querySelectorAll("[data-tab-jump]").forEach((btn) => {
      btn.addEventListener("click", () => setTab(btn.dataset.tabJump));
    });
    $("btnHome").onclick = () => setTab("home");

    function updateUserUI() {
      $("userBadge").textContent = state.loggedIn
        ? `${state.user.id} · ${state.subscribed ? "구독" : "회원"}${state.user.role === "admin" ? " · 관리자" : ""}`
        : "게스트 · 비로그인";
      $("btnLogin").textContent = state.loggedIn ? "로그아웃" : "로그인";
      $("btnSignup").textContent = state.loggedIn ? "계정" : "회원가입";
      if ($("generateLock")) $("generateLock").style.display = state.subscribed ? "none" : "inline-flex";
      if ($("analyzeLock")) $("analyzeLock").style.display = state.loggedIn ? "none" : "inline-flex";
    }

    function doLogout() {
      state.loggedIn = false;
      state.subscribed = false;
      state.user = null;
      updateUserUI();
      setTab("home");
    }

    function doLogin(id, pwd) {
      const found = state.users.find((u) => u.id === id && u.pwd === pwd);
      if (!found) {
        alert("아이디 또는 비밀번호를 확인하세요.");
        return;
      }
      state.loggedIn = true;
      state.user = { ...found };
      state.subscribed = !!found.subscribed;
      updateUserUI();
      alert(`${found.id}님 환영합니다.`);
      setTab("home");
    }

    function doSignup(id, pwd, pwd2) {
      if (!id || !pwd || !pwd2) return alert("모든 항목을 입력하세요.");
      if (pwd !== pwd2) return alert("비밀번호가 일치하지 않습니다.");
      if (state.users.find((u) => u.id === id)) return alert("이미 존재하는 아이디입니다.");
      const user = { id, pwd, role: "user", subscribed: false };
      state.users.push(user);
      alert("가입이 완료되었습니다. 로그인해주세요.");
      setTab("login");
    }

    $("btnLogin").onclick = () => {
      if (state.loggedIn) {
        doLogout();
      } else {
        setTab("login");
      }
    };
    $("btnSignup").onclick = () => setTab(state.loggedIn ? "home" : "signup");

    $("btnDoLogin").onclick = () => doLogin($("loginId").value.trim(), $("loginPwd").value);
    $("btnDoSignup").onclick = () => doSignup($("signupId").value.trim(), $("signupPwd").value, $("signupPwd2").value);

    $("btnSubscribe").onclick = () => {
      if (!state.loggedIn) {
        alert("로그인 후 구독할 수 있습니다.");
        return setTab("login");
      }
      state.subscribed = true;
      if (state.user) state.user.subscribed = true;
      updateUserUI();
      setTab("generate");
      alert("구독이 활성화되었습니다. AI 도면 생성 기능을 준비 중입니다.");
    };
    $("btnNotify").onclick = () => alert("준비되면 이메일로 안내해드리겠습니다.");

    function formatSize(bytes) {
      if (!bytes && bytes !== 0) return "-";
      const sizes = ["B", "KB", "MB", "GB"];
      const i = Math.min(Math.floor(Math.log(bytes) / Math.log(1024)), sizes.length - 1);
      const val = bytes / 1024 ** i;
      return `${val.toFixed(val >= 10 || i === 0 ? 0 : 1)} ${sizes[i]}`;
    }

    function renderFileList(kind) {
      const listEl = kind === "convert" ? $("convertList") : $("analyzeList");
      const files = kind === "convert" ? state.convertFiles : state.analyzeFiles;
      listEl.innerHTML = "";
      if (files.length === 0) {
        listEl.innerHTML = '<div class="muted">파일을 추가하세요.</div>';
        return;
      }
      files.forEach((file, idx) => {
        const row = document.createElement("div");
        row.className = "file-row";
        row.innerHTML = `
          <div class="file-main">
            <div class="file-name">${file.name}</div>
            <div class="status-line">
              <span class="status-pill ${file.status}">${file.statusLabel}</span>
              <span>${file.log}</span>
            </div>
          </div>
          <div>
            <div class="muted">용량 ${formatSize(file.size)}</div>
            <div class="muted">진행률 ${file.progress}%</div>
            <div class="progress"><div class="progress-bar" style="width:${file.progress}%;"></div></div>
          </div>
          <div class="actions-row">
            <button class="btn" data-action="select">선택</button>
            <button class="btn" data-action="download" ${file.status !== "done" ? "disabled" : ""}>다운로드</button>
            <button class="btn ghost" data-action="remove">삭제</button>
          </div>
        `;
        row.querySelectorAll("button").forEach((b) =>
          b.addEventListener("click", () => handleFileAction(kind, idx, b.dataset.action))
        );
        listEl.appendChild(row);
      });
    }

    function handleFileAction(kind, idx, action) {
      const files = kind === "convert" ? state.convertFiles : state.analyzeFiles;
      const file = files[idx];
      if (!file) return;
      if (action === "remove") {
        files.splice(idx, 1);
      } else if (action === "select") {
        file.selected = !file.selected;
        alert(`${file.name} ${file.selected ? "선택" : "선택 해제"}되었습니다.`);
      } else if (action === "download" && file.status === "done") {
        alert(`${file.name} 변환본을 다운로드합니다.`);
      }
      renderFileList(kind);
    }

    function addFiles(kind, fileList) {
      const target = kind === "convert" ? state.convertFiles : state.analyzeFiles;
      Array.from(fileList).forEach((f) => {
        target.push({
          name: f.name,
          size: f.size,
          progress: 0,
          status: "ready",
          statusLabel: "준비",
          log: "대기 중",
          selected: false,
        });
      });
      renderFileList(kind);
    }

    function simulate(kind, statusFlow) {
      const files = kind === "convert" ? state.convertFiles : state.analyzeFiles;
      const targets = files.filter((f) => (f.selected || files.every((ff) => !ff.selected)));
      targets.forEach((file) => {
        let step = 0;
        file.progress = 10;
        file.status = "uploading";
        file.statusLabel = statusFlow[0].label;
        file.log = statusFlow[0].log;
        renderFileList(kind);
        const tick = () => {
          step += 1;
          if (step >= statusFlow.length) {
            file.progress = 100;
            file.status = "done";
            file.statusLabel = "완료";
            file.log = "완료되었습니다.";
            renderFileList(kind);
            updateResultList();
            return;
          }
          const cur = statusFlow[step];
          file.progress = cur.progress;
          file.status = cur.status;
          file.statusLabel = cur.label;
          file.log = cur.log;
          renderFileList(kind);
          setTimeout(tick, 800);
        };
        setTimeout(tick, 800);
      });
    }

    $("dropConvert").addEventListener("click", () => $("inputConvert").click());
    $("dropAnalyze").addEventListener("click", () => $("inputAnalyze").click());
    $("inputConvert").addEventListener("change", (e) => addFiles("convert", e.target.files));
    $("inputAnalyze").addEventListener("change", (e) => addFiles("analyze", e.target.files));

    function bindDropzone(el, kind) {
      ["dragenter", "dragover"].forEach((evt) =>
        el.addEventListener(evt, (e) => {
          e.preventDefault();
          el.classList.add("dragover");
        })
      );
      ["dragleave", "drop"].forEach((evt) =>
        el.addEventListener(evt, (e) => {
          e.preventDefault();
          el.classList.remove("dragover");
        })
      );
      el.addEventListener("drop", (e) => {
        e.preventDefault();
        const files = e.dataTransfer.files;
        addFiles(kind, files);
      });
    }
    bindDropzone($("dropConvert"), "convert");
    bindDropzone($("dropAnalyze"), "analyze");

    $("btnConvertStart").onclick = () =>
      simulate("convert", [
        { status: "uploading", label: "업로드 중", log: "서버로 전송 중", progress: 30 },
        { status: "processing", label: "DXF 변환 중", log: "odaconverter 실행", progress: 70 },
        { status: "done", label: "완료", log: "DXF 생성 완료", progress: 100 },
      ]);
    $("btnConvertDownload").onclick = () => alert("완료된 DXF 파일을 다운로드합니다.");

    $("btnParse").onclick = () => {
      if (!state.loggedIn) return alert("로그인 후 이용 가능합니다.");
      simulate("analyze", [
        { status: "uploading", label: "업로드 중", log: "서버로 전송 중", progress: 30 },
        { status: "processing", label: "파싱 중", log: "ezdxf 기본 파싱 수행", progress: 75 },
        { status: "done", label: "완료", log: "파싱 결과 저장", progress: 100 },
      ]);
    };
    $("btnNext").onclick = () => alert("세부 설정 영역으로 이동했습니다. 설정을 입력한 후 분석하기를 눌러주세요.");
    $("btnAnalyze").onclick = () => {
      if (!state.loggedIn) return alert("로그인 후 이용 가능합니다.");
      alert("지정된 블록/레이어 설정을 기반으로 AI 분석을 실행합니다.");
      updateResultList(true);
    };

    function updateResultList(forceAdd = false) {
      const list = $("resultList");
      list.innerHTML = "";
      if (forceAdd && state.analyzeFiles.length > 0 && !state.selectedResult) {
        state.selectedResult = state.analyzeFiles[0];
      }
      state.analyzeFiles.forEach((f, idx) => {
        const item = document.createElement("div");
        item.className = "file-row";
        item.style.gridTemplateColumns = "1fr auto";
        item.innerHTML = `
          <div>
            <div class="file-name">${f.name}</div>
            <div class="muted">진행률 ${f.progress}% · ${f.log}</div>
          </div>
          <button class="btn ${state.selectedResult === f ? "primary" : ""}" data-idx="${idx}">보기</button>
        `;
        item.querySelector("button").onclick = () => {
          state.selectedResult = f;
          updateResultList();
          renderResultView();
        };
        list.appendChild(item);
      });
      if (state.analyzeFiles.length === 0) {
        list.innerHTML = '<div class="muted">파싱된 파일이 없습니다.</div>';
      }
      renderResultView();
    }

    function renderResultView() {
      const view = $("resultView");
      const file = state.selectedResult;
      if (!file) {
        view.innerHTML = '<div class="muted">분석 결과를 보려면 파일을 선택하세요.</div>';
        return;
      }
      view.innerHTML = `
        <div class="pill">AI 도면 분석 결과</div>
        <h3 style="margin:8px 0 6px;">파일: ${file.name} / 단위: mm</h3>
        <div class="card" style="padding:12px; background: rgba(0,0,0,0.15); margin:8px 0;">도면 미리보기 영역 (SVG 뷰어 자리)</div>
        <div class="accordion">
          <div class="acc-header" data-acc="basic">DXF 기본 파싱 내용</div>
          <div class="acc-body" id="acc-basic">
            <div class="muted">총 엔티티 120EA (LINE: 30, POLYLINE: 25, TEXT: 18 ...)</div>
            <div class="actions-row" style="margin:8px 0;">
              <button class="btn">JSON 다운로드</button>
              <button class="btn">CSV 다운로드</button>
            </div>
            <div class="table-wrap">
              <table>
                <thead><tr><th>레이어명</th><th>색상</th></tr></thead>
                <tbody><tr><td>AXIS</td><td>#00ff99</td></tr><tr><td>WALL</td><td>#cccccc</td></tr></tbody>
              </table>
            </div>
            <div class="table-wrap" style="margin-top:8px;">
              <table>
                <thead><tr><th>블록명</th><th>개수</th></tr></thead>
                <tbody><tr><td>TITLE_BLOCK</td><td>4</td></tr></tbody>
              </table>
            </div>
            <div class="table-wrap" style="margin-top:8px;">
              <table>
                <thead><tr><th>ID</th><th>TYPE</th><th>LAYER</th><th>TEXT</th><th>Coordinates</th></tr></thead>
                <tbody><tr><td>1</td><td>LINE</td><td>AXIS</td><td>-</td><td>[0,0],[10,0]</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="accordion">
          <div class="acc-header" data-acc="ai">AI 분석 내용</div>
          <div class="acc-body" id="acc-ai">
            <div class="muted">세부 설정에 따라 도출된 분석 리포트가 여기에 표시됩니다.</div>
            <div class="actions-row" style="margin:8px 0;">
              <button class="btn">JSON 다운로드</button>
              <button class="btn">CSV 다운로드</button>
            </div>
            <div class="table-wrap">
              <table>
                <thead><tr><th>항목</th><th>값</th></tr></thead>
                <tbody><tr><td>도곽 블록</td><td>${$("blockTitle").value || "미지정"}</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>
      `;
      document.querySelectorAll(".acc-header").forEach((h) => {
        h.onclick = () => {
          const body = $("acc-" + h.dataset.acc);
          body.classList.toggle("open");
        };
      });
    }

    setTab("home");
    updateUserUI();
  </script>
</body>
</html>
